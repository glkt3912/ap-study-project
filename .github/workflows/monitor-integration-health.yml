name: Integration CI/CD (Multi-Repository Coordination)

on:
  # Trigger when both frontend and backend have changes
  push:
    branches: [ main ]
  # Weekly integration health check
  schedule:
    - cron: '0 11 * * 1'  # Every Monday 11:00 UTC
  # Manual trigger for integration testing
  workflow_dispatch:
    inputs:
      test_backend:
        description: 'Run backend integration tests'
        required: false
        default: 'true'
        type: boolean
      test_frontend:
        description: 'Run frontend integration tests'
        required: false
        default: 'true'
        type: boolean

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend }}
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: Check for changes
      id: changes
      run: |
        if git diff --name-only HEAD^ HEAD | grep -q "ap-study-backend/"; then
          echo "backend=true" >> $GITHUB_OUTPUT
        else
          echo "backend=false" >> $GITHUB_OUTPUT
        fi
        
        if git diff --name-only HEAD^ HEAD | grep -q "ap-study-app/"; then
          echo "frontend=true" >> $GITHUB_OUTPUT
        else
          echo "frontend=false" >> $GITHUB_OUTPUT
        fi

  integration-health:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.backend_changed == 'true' || needs.check-changes.outputs.frontend_changed == 'true' || github.event_name == 'workflow_dispatch'
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.17.1'

    - name: Check repository structure
      run: |
        echo "## ğŸ—ï¸ Repository Structure Health" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Repository | Status | Last Update |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
        
        # Check backend
        if [ -d "ap-study-backend" ]; then
          BACKEND_COMMIT=$(git log -1 --format="%h %s" -- ap-study-backend/ || echo "No commits")
          echo "| ap-study-backend | âœ… Present | $BACKEND_COMMIT |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ap-study-backend | âŒ Missing | - |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check frontend
        if [ -d "ap-study-app" ]; then
          FRONTEND_COMMIT=$(git log -1 --format="%h %s" -- ap-study-app/ || echo "No commits")
          echo "| ap-study-app | âœ… Present | $FRONTEND_COMMIT |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ap-study-app | âŒ Missing | - |" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check package.json compatibility
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“¦ Package Compatibility" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Backend version check
        if [ -f "ap-study-backend/package.json" ]; then
          BACKEND_NODE=$(cat ap-study-backend/package.json | grep -o '"node":[^"]*"[^"]*"' | cut -d'"' -f4 || echo "Not specified")
          echo "- **Backend Node.js**: $BACKEND_NODE" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Frontend version check  
        if [ -f "ap-study-app/package.json" ]; then
          FRONTEND_NODE=$(cat ap-study-app/package.json | grep -o '"node":[^"]*"[^"]*"' | cut -d'"' -f4 || echo "Not specified")
          echo "- **Frontend Node.js**: $FRONTEND_NODE" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- **CI Node.js**: 22.17.1 LTS" >> $GITHUB_STEP_SUMMARY

    - name: Integration Summary
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ”— Integration Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Changes Detected" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend**: ${{ needs.check-changes.outputs.backend_changed }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend**: ${{ needs.check-changes.outputs.frontend_changed }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Coordination Status" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ”„ Multi-repository structure validated" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“‹ Package version compatibility checked" >> $GITHUB_STEP_SUMMARY
        echo "- âš¡ Individual repository CIs handle detailed testing" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š Root repository provides integration oversight" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> ğŸ¤– Generated by integration-ci workflow"